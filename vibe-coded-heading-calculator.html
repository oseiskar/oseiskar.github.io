<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heading Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeafletJS for the interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* Ensure the map covers the entire screen */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling */
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        /* Style for the overlay dialog to prevent map interaction */
        .dialog-visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }
        .dialog-hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) scale(0.95);
        }
    </style>
</head>
<body class="font-sans">

    <div class="relative w-screen h-screen">
        <!-- Map Container -->
        <div id="map" class="z-0"></div>

        <!-- Overlay Dialog for Instructions and Results -->
        <div id="dialog" class="absolute bottom-10 left-1/2 z-[1000] bg-white p-6 rounded-xl shadow-2xl text-center w-11/12 max-w-md transition-all duration-300 ease-in-out">
            <!-- Instructions Content -->
            <div id="instructions-content">
                 <h1 class="text-xl md:text-2xl font-bold text-blue-600 mb-2">Heading Calculator</h1>
                 <p id="instructions" class="text-gray-700">Click the map to set a starting point.</p>
                 <button id="gps-button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg w-full transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
                    Use My Location
                </button>
            </div>

            <!-- Results Content (initially hidden) -->
            <div id="results-content" class="hidden">
                 <h2 class="text-lg font-medium text-gray-500">Heading Angle</h2>
                 <p id="heading-result" class="text-5xl font-bold text-blue-600 my-2">-</p>
                 <p class="text-sm text-gray-500">Degrees from True North</p>
                 <button id="reset-button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg w-full transition-colors">
                     Calculate Another
                 </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Element References
        const mapElement = document.getElementById('map');
        const dialogElement = document.getElementById('dialog');
        const instructionsElement = document.getElementById('instructions');
        const instructionsContentElement = document.getElementById('instructions-content');
        const resultsContentElement = document.getElementById('results-content');
        const headingResultElement = document.getElementById('heading-result');
        const resetButton = document.getElementById('reset-button');
        const gpsButton = document.getElementById('gps-button');

        // State variables
        let points = [];
        let markers = [];
        let polyline = null;

        // --- 1. INITIALIZE MAP ---
        const map = L.map(mapElement, { zoomControl: false }).setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);


        // --- 2. CORE FUNCTIONS ---

        /**
         * Calculates the heading between two geographical points.
         */
        function calculateHeading(point1, point2) {
            const toRadians = deg => deg * Math.PI / 180;
            const toDegrees = rad => (rad * 180 / Math.PI + 360) % 360;

            const lat1 = toRadians(point1.lat);
            const lon1 = toRadians(point1.lng);
            const lat2 = toRadians(point2.lat);
            const lon2 = toRadians(point2.lng);

            const deltaLon = lon2 - lon1;

            const y = Math.sin(deltaLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLon);
            
            const initialBearing = Math.atan2(y, x);
            return toDegrees(initialBearing);
        }

        /**
         * Updates the UI with the latest information.
         */
        function updateUI() {
            switch (points.length) {
                case 0: // Initial state
                    dialogElement.classList.remove('dialog-hidden');
                    dialogElement.classList.add('dialog-visible');
                    instructionsContentElement.classList.remove('hidden');
                    resultsContentElement.classList.add('hidden');
                    instructionsElement.textContent = 'Click the map or use GPS to set a starting point.';
                    gpsButton.disabled = false;
                    break;
                case 1: // First point selected
                    instructionsElement.textContent = 'Select a destination point on the map, or use GPS.';
                    gpsButton.disabled = false;
                    break;
                case 2: // Second point selected, show results
                    const heading = calculateHeading(points[0], points[1]);
                    headingResultElement.textContent = `${heading.toFixed(2)}Â°`;
                    
                    dialogElement.classList.remove('dialog-hidden');
                    dialogElement.classList.add('dialog-visible');
                    instructionsContentElement.classList.add('hidden');
                    resultsContentElement.classList.remove('hidden');
                    gpsButton.disabled = true;
                    break;
            }
        }

        /**
         * Adds a point to the map and state.
         */
        function addPoint(latlng) {
            if (points.length >= 2) return;

            points.push(latlng);

            const markerColor = points.length === 1 ? 'green' : 'red';
            const marker = L.marker(latlng, {
                icon: L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${markerColor}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                })
            }).addTo(map);
            markers.push(marker);

            if (points.length === 2) {
                polyline = L.polyline(points, { color: 'blue' }).addTo(map);
            }
            
            updateUI();
        }

        /**
         * Resets the application state to its initial form.
         */
        function resetApp() {
            points = [];
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            updateUI();
        }

        /**
         * Handles the logic for getting user's GPS location.
         */
        function handleGeolocation() {
            if ('geolocation' in navigator) {
                gpsButton.disabled = true;
                gpsButton.textContent = 'Locating...';
                instructionsElement.textContent = 'Requesting location...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const userLocation = L.latLng(latitude, longitude);
                        map.setView(userLocation, 13);
                        addPoint(userLocation);
                        gpsButton.textContent = 'Use My Location';
                    },
                    (error) => {
                        console.warn(`Geolocation error: ${error.message}`);
                        gpsButton.textContent = 'Use My Location';
                        // Re-enable the button only if the calculation isn't complete
                        gpsButton.disabled = points.length >= 2; 
                        updateUI(); // Restore previous instruction
                    }
                );
            } else {
                instructionsElement.textContent = 'GPS not supported on this device.';
            }
        }
        
        // --- 3. EVENT LISTENERS & INITIALIZATION ---
        
        map.on('click', (e) => addPoint(e.latlng));
        resetButton.addEventListener('click', resetApp);
        gpsButton.addEventListener('click', handleGeolocation);
        
        // Set initial UI state
        updateUI();

    </script>
</body>
</html>



